<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v5.js"></script>
    <script src="derivadas.js"></script>
</head>
<style>


text {
  fill: #000;
  font: 10px sans-serif;
  pointer-events: none;
}

</style>
<body>
<script>

var margin = {top: 30, bottom: 30, left: 50, right:30},
    width = 600 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom,
    svg = d3.select("body").append("svg")
                    .attr("height", height + margin.top + margin.bottom)
                    .attr("width", width + margin.left + margin.right)
                    .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
    xScale = d3.scaleLinear()
                .range([0, width]),
    yScale = d3.scaleLinear()
                .range([height, 0]),
    xGen = d3.axisBottom(xScale)
                .ticks(7),
    yGen = d3.axisLeft(yScale)
                .ticks(7),
    xAxis = svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xGen),
    yAxis = svg.append("g")
                .attr("class", "y-axis")
                .call(yGen),
    colors = d3.scaleOrdinal(d3.schemeCategory10),
    tooltip = d3.select("body").append("div")
                .style("position", "absolute")
                .attr("class", "tooltip")
                .style("left", "50px")
                .style("top", "50px")
                .style("opacity", 0);

// seleccion de variables

    var body = d3.select('body')
    var selectData = [ { "text" : "Age" },
                     { "text" : "Resting blood pressure (in mm Hg on admission to the hospital)" },
                     { "text" : "Serum cholestoral in mg/dl"},
                     { "text" : "Maximum heart rate achieved"},
                     { "text" : "ST depression induced by exercise relative to rest"},
                   ]
    var selectCategorical = [ {"text" : "Sex" },
                            {"text" : "Chest pain type" },
                            { "text" : "Fasting blood sugar > 120 mg/dl (0 = false; 1 = true)"},
                            { "text" : "Resting electrocardiographic results (0 = normal; 1 = abnormal; 2 = problem" },
                            { "text" : "Exercise induced angina (0 = no; 1 = yes)" },
                            { "text" : "Slope of the peak exercise ST segment (1 = upsloping; 2 = flat; 3=downsloping)" },
                            { "text" : "Number of major vessels (0-3) colored by flourosopy " },
                            { "text" : "Thal (3 = normal; 6 = fixed defect; 7 = reversable defect)" },
                            { "text" : "diagnosis of heart disease" }

                            ]

    var diccio = { "Age": "age",
                "Sex": "sex",
                "Resting blood pressure (in mm Hg on admission to the hospital)": "blood_pressure"  ,
                 "Serum cholestoral in mg/dl": "cholestoral",
                 "Maximum heart rate achieved": "heart_rate",
                 "ST depression induced by exercise relative to rest": "st_depression",
                "Chest pain type": "chest_pain",
                "Fasting blood sugar > 120 mg/dl (0 = false; 1 = true)": "blood_sugar",
                "Resting electrocardiographic results (0 = normal; 1 = abnormal; 2 = problem": "electrocard" ,
                "Exercise induced angina (0 = no; 1 = yes)": "exercise" ,
                "Slope of the peak exercise ST segment (1 = upsloping; 2 = flat; 3=downsloping)": "slope_exercise" ,
                "Number of major vessels (0-3) colored by flourosopy ": "number_vessels" ,
                "Thal (3 = normal; 6 = fixed defect; 7 = reversable defect)": "thal" ,
                "diagnosis of heart disease": "diagnosis" };




d3.csv("data.csv")
    .then(function(data){

        let deri1 = [];
        let deri2 = [];
        data.forEach(function(d) {
            let neighbours = vecinos(d, data, 50, "age", "blood_pressure");
            let primera = primera_derivada(d, neighbours,  "age", "blood_pressure");
            deri1.push(primera);
            deri2.push(segunda_derivada(d, data, 50, "age", "blood_pressure"));
        })
        console.log(deri1);
        console.log(deri2);

        data.forEach(function(d) {
            d['age'] = +d['age']
            d['sex'] = +d['sex']
            d['chest_pain'] = +d['chest_pain']
            d['heart_rate'] = +d['heart_rate']
            d['blood_pressure'] = +d['blood_pressure']
            d['cholestoral'] = +d['cholestoral']
            d['blood_sugar'] = +d['blood_sugar']
            d['electrocard'] = +d['electrocard']
            d['exercise'] = +d['exercise']
            d['st_depression'] = +d['st_depression']
            d['slope_exercise'] = +d['slope_exercise']
            d['number_vessels'] = +d['number_vessels']
            d['thal'] = +d['thal']
            d['diagnosis'] = +d['diagnosis']
        });

            // Select X-axis Variable
          var span = body.append('span')
            .text('Select X-Axis variable: ')
          var yInput = body.append('select')
              .attr('id','xSelect')
              .on('change',xChange)
            .selectAll('option')
              .data(selectData)
              .enter()
            .append('option')
              .attr('value', function (d) { return d.text })
              .text(function (d) { return d.text ;})
          body.append('br')

          // Select Y-axis Variable
          var span = body.append('span')
              .text('Select Y-Axis variable: ')
          var yInput = body.append('select')
              .attr('id','ySelect')
              .on('change',yChange)
            .selectAll('option')
              .data(selectData)
              .enter()
            .append('option')
              .attr('value', function (d) { return d.text })
              .text(function (d) { return d.text ;})
          body.append('br')

        // Select categorical variable
        var span = body.append('span')
              .text('Select Categorical variable: ')
          var yInput = body.append('select')
              .attr('id','CSelect')
              .on('change',cChange)
            .selectAll('option')
              .data(selectCategorical)
              .enter()
            .append('option')
              .attr('value', function (d) { return d.text })
              .text(function (d) { return d.text ;})
          body.append('br')

        xScale
            .domain([d3.min(data, function(d) {return d['age'] * 1.1;}), d3.max(data, function(d) {return d['age'] * 1.1;})]);
        yScale
            .domain([0, d3.max(data, function(d) {return d['cholestoral'] * 1.1;})]);
        svg.select(".x-axis").transition()
            .duration(1000)
            .call(xGen);
        svg.select(".y-axis").transition()
            .duration(1000)
            .call(yGen);

        var x = "age",
            y = "cholestoral";

        var lines = svg.selectAll(".line")
                          .data(data)

        var circles = svg.selectAll(".circle")
                            .data(data);

        var new_circles = circles
                            .enter().append("circle")
                                    .attr("r", 4)
                                    .attr('stroke','black')
                                    .attr('stroke-width',0)
                                    .on("mouseover", function(d) {
                                                d3.select(d3.event.target)
                                                    .transition()
                                                        .duration(500)
                                                        .attr("r", 10)
                                                        .attr('stroke-width',3);
                                                tooltip.transition()
                                                        .duration(300)
                                                        .style("opacity", 1);
                                                tooltip
                                                    .style("left", (d3.event.pageX + 10) + "px")
                                                    .style("top", (d3.event.pageY + 10) + "px")
                                                    .html(x + ": " + d[x] + "<br>" + y + ": " + d[y])
                                                })
                                    .on('mouseout', function () {
                                                d3.select(d3.event.target)
                                                  .transition()
                                                  .duration(500)
                                                  .attr('r',4)
                                                  .attr('stroke-width',0);
                                                tooltip.transition()
                                                   .duration(300)
                                                   .style("opacity", 0);
                                              })
                                    .merge(circles)
                                    .transition()
                                        .duration(1000)
                                            .attr("cx", function(d) {
                                                return xScale(d['age']) + margin.left;
                                            })
                                            .attr("cy", function(d) {
                                                return yScale(d['cholestoral']);
                                            })
                                            .attr("fill", function(d) {
                                                return colors(d['sex']);
                                            })

        bars
            .exit()
                .transition()
                    .duration(500)
                    .style('opacity', 0)
                    .remove();
        console.log("hola")
        var new_lines = lines
                            .enter().append("line")
                                    .attr("x1", function(d) {
                                      return xScale(d['age']) + margin.lef - 5;
                                    })
                                    .attr("x2", function(d) {
                                      return xScale(d['age']) + margin.lef + 5
                                    })
                                    .attr("y1", function(d) {
                                      let neighbours = vecinos(d, data, 50, "age", "blood_pressure");
                                      let primera = primera_derivada(d, neighbours,  "age", "blood_pressure");
                                      console.log(primera)
                                      return yScale(d['cholestoral']) - 5*primera;
                                    })
                                    .attr("y2", function(d) {
                                      let neighbours = vecinos(d, data, 50, "age", "blood_pressure");
                                      let primera = primera_derivada(d, neighbours,  "age", "blood_pressure");
                                      return yScale(d['cholestoral']) + 5*primera;
                                    })
                                    .attr("stroke", function(d){
                                      return colors(d['sex']);
                                    });

        function xChange() {
            var value = diccio[this.value]
            x = value
            xScale
                .domain([d3.min(data, function(d) {return d[value] * 1.1;}), d3.max(data, function(d) {return d[value] * 1.1;})]);
                svg.select(".x-axis").transition()
                    .duration(1000)
                    .call(xGen);
            d3.selectAll("circle").transition()
                .duration(1000)
                .attr("cx", function(d) {
                    return xScale(d[value]) + margin.left;
                })
        };

        function yChange() {
            var value = diccio[this.value]
            y = value
            yScale
                .domain([0, d3.max(data, function(d) {return d[value] * 1.1;})]);
            svg.select(".y-axis").transition()
                .duration(1000)
                .call(yGen);
            d3.selectAll("circle").transition()
                .duration(1000)
                .attr("cy", function(d) {
                    return yScale(d[value]);
                });

        };

        function cChange() {
            var value = diccio[this.value]
             d3.selectAll('circle')
              .transition()
                .duration(1000)
                .attr('fill',function (d) { return colors(d[value]) })

        };
    });

</script>

</body>




